{% extends 'base.html' %}

{% block title %}PRS - Salesperson Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Header -->
{% include 'components/header.html' with username=username role=role today=today %}

<!-- Navigation Tabs -->
{% include 'components/navigation_tabs.html' %}

<!-- Tab Content -->
<div class="tab-content">
    <!-- Deals Tab -->
    <div class="tab-pane fade show active" id="deals-content">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary text-white rounded-circle p-3 me-3">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Total Deals</h6>
                        <h3 class="mb-0" id="totalDealsCount">{{ deals|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createDealModal">
                    <i class="bi bi-plus-circle me-1"></i> Create Deal
                </button>
                <a href="{% url 'client_management' %}" class="btn btn-outline-info">
                    <i class="bi bi-person-lines-fill me-1"></i> Client Management
                </a>
            </div>
        </div>

        <!-- Include Client Management Modal -->
        {% include 'components/client_management_modal.html' %}
        <script>
            window.currentUsername = "{{ username }}";
        </script>

        <!-- Deal List -->
        {% include 'components/deals_table.html' with deals=deals %}

    </div>
    
    <!-- Projects Tab -->
    <div class="tab-pane fade" id="projects-content">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success text-white rounded-circle p-3 me-3">
                        <i class="bi bi-folder"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">My Projects</h6>
                        <h3 class="mb-0" id="totalProjectsCount">{{ projects|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" onclick="showFileUploadModal()">
                    <i class="bi bi-cloud-upload me-2"></i> Upload Files
                </button>
            </div>
        </div>
        
        <!-- Projects Table Component -->
        {% include 'components/projects_table.html' with projects=projects %}
        <!-- Project Files Management Card START -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Project Files Management</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <select class="form-select" id="projectSelectFilter" onchange="filterProjectFiles()">
                                <option value="all">All Projects</option>
                                <!-- Projects will be loaded dynamically -->
                            </select>
                            <button class="btn btn-outline-secondary" onclick="loadProjects()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="fileSearchInput" placeholder="Search files..." onkeyup="filterProjectFiles()">
                            <button class="btn btn-outline-secondary" type="button" onclick="filterProjectFiles()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Files List -->
                <div id="projectFilesContainer">
                    <div class="text-center py-5" id="loadingFiles">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="noFilesMessage" style="display: none;">
                        <div class="alert alert-info">
                            <p class="mb-0">No files found. Upload files to a project using the "Upload Files" button.</p>
                        </div>
                    </div>
                    <div id="filesTableContainer" style="display: none;">
                        <table class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>File Name</th>
                                    <th>Project</th>
                                    <th>Uploaded</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="filesTableBody">
                                <!-- Files will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Project Files Management Card END -->
    </div>

<!-- Document Preview Modal -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="documentPreviewContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" id="downloadFileBtn" class="btn btn-primary" download>
                    <i class="bi bi-download me-2"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Project Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="fileUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="upload_project_select" class="form-label">Select Project</label>
                        <select class="form-select" id="upload_project_select" name="project_id" required>
                            <option value="">Select a project</option>
                            <!-- Projects will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="file_description" name="description" rows="2" placeholder="Describe the file(s) you're uploading"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="project_files" class="form-label">Files</label>
                        <input type="file" class="form-control" id="project_files" name="files" multiple required>
                        <div class="form-text">
                            You can upload multiple files. Supported formats include documents, images, PDFs, and ZIP archives.
                        </div>
                    </div>
                    <div class="progress mb-3 d-none" id="uploadProgressContainer">
                        <div class="progress-bar" id="uploadProgressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadFilesBtn" onclick="uploadProjectFiles()">Upload Files</button>
            </div>
        </div>
    </div>
</div>

<!-- Store user information for JavaScript use -->
<input type="hidden" id="username" value="{{ username }}">
<input type="hidden" id="role" value="{{ role }}">

<!-- Modals -->
{% include 'components/create_deal_modal.html' with supervisors=supervisors today=today %}
{% include 'components/file_upload_modal.html' with projects=projects %}

<!-- Deal Details Modal -->
<div class="modal fade" id="dealDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i> Deal Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="dealDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Custom JavaScript -->
<!-- Initialize session variables for JavaScript -->
<script>
    // Pass Django session username to JavaScript
    window.currentUsername = "{{ request.session.username }}";
    console.log('Initializing dashboard with username:', window.currentUsername);
</script>
<script src="/static/js/form-utils.js"></script>
<script src="/static/js/deal-manager.js"></script>
<script src="/static/js/project-manager.js"></script>
<script src="/static/js/project-viewer.js"></script>
<script src="/static/js/dashboard-utils.js"></script>
<script>
    // Initialize the dashboard when page loads
    initializeDashboard();
</script>

{% endblock %}
